# 阿里云 ESA/DCDN 自动续费工具 (PHP版)

[![PHP Version](https://img.shields.io/badge/php-7.4%2B-blue.svg)](https://www.php.net/)
[![License](https://img.shields.io/badge/license-MIT-green.svg)](LICENSE)

这是一个基于 PHP 开发的单文件工具，用于便捷地查询和续费阿里云 **ESA (边缘安全加速)** 及 **DCDN (全站加速)** 实例。

本项目解决了阿里云控制台续费操作繁琐的问题，提供了一个简洁的 Web 界面，支持实时日志查看、批量循环续费以及针对特殊产品代码（如 `dcdn`）的自动兼容。

---

## 🚨 安全特别警示 (Security Warning)

> **⚠️ 极其重要：请务必阅读以下内容！**

1.  **敏感信息风险**：本项目需要使用阿里云的 `AccessKey ID` 和 `AccessKey Secret`。这两个密钥等同于您的账号密码，拥有操作您云资源的权限。
2.  **严禁使用公共服务**：请**不要**在任何第三方搭建的、来源不明的本工具网站上输入您的 AK/SK。这极有可能导致您的密钥泄露，造成严重的资金损失或资源被恶意利用。
3.  **仅限私有部署**：建议您将本代码部署在**自己控制的服务器**、虚拟主机或本地环境中。
4.  **用完即删**：建议在完成续费操作后，从服务器上删除 `esa.php` 文件，或使用阿里云 RAM 访问控制，仅给该 AK 分配最小权限（如仅允许续费接口，虽配置较繁琐但更安全）。

**开发者免责声明**：本工具仅供技术交流与个人使用。使用者因在不安全环境使用导致的信息泄露或资产损失，开发者不承担任何责任。

---

## ✨ 功能特性

* **⚡️ 单文件部署**：无需数据库，无需复杂的环境配置，上传即用。
* **📡 实时日志 (SSE)**：使用 Server-Sent Events 技术，像终端一样实时展示续费进度和阿里云 API 返回结果。
* **🎨 现代化 UI**：内置精美的暗黑主题 (Dark Mode) 界面，完美适配手机端和 PC 端。
* **🛠 自动修正**：内置针对阿里云 ESA 底层对应 `dcdn` 计费代码的自动转换逻辑，无需手动查找复杂参数。
* **🛡 安全限制**：强制限制 API 请求频率（最低 5 秒间隔），防止被阿里云 API 网关限流或封禁。
* **🔗 便捷入口**：集成阿里云 RAM 控制台跳转链接，方便快速查找密钥。

---

## 🚀 快速开始

### 1. 环境要求
* **PHP 版本**：PHP 7.4 。
* **PHP 扩展**：需开启 `curl` 和 `openssl` 扩展。
* **Web 服务器**：Nginx、Apache 或 OpenLiteSpeed 均可。

### 2. 部署步骤
本程序为**单文件**架构，部署极其简单：

1.  下载本仓库中的 `esa.php` 文件。
2.  将其上传到您 Web 服务器的**网站根目录**（或任意子目录）。
3.  确保服务器对当前目录有**写入权限**（程序需要创建临时文件 `tmp/` 目录用于存放任务状态）。
    * *Linux/宝塔面板示例：* 确保目录权限为 `755` 或 `777`。

### 3. 如何使用
1.  在浏览器中访问：`http://您的域名/esa.php`。
2.  填写您的阿里云 **AccessKeyId** 和 **AccessKeySecret**。
3.  填写 **InstanceId**（实例 ID，例如 `esa-site-xxxxx`）。
4.  选择续费时长（1个月/1年等）。
5.  点击 **“查询到期时间”** 确认实例存在且密钥正确。
6.  点击 **“开始续费”**，观察下方实时日志直到出现 `✅ 成功！订单号: xxxxx`。

---

## ⚙️ 高级配置说明

通常情况下，您**不需要**填写“高级设置”中的内容。脚本会自动处理参数。

仅当您遇到“未找到实例”或“续费失败”且日志提示产品代码不匹配时，才需要手动填写：

* **ProductCode**: 默认为 `dcdn`（ESA 产品底层代码）。
* **ProductType**: 默认为 `dcdn_dcdnserviceplan_public_cn`。
* **Region**: 默认为 `cn-hangzhou`（ESA 的计费中心通常在杭州）。

---

## ❓ 常见问题 (FAQ)

**Q: 点击“开始续费”后一直在转圈，没有日志？**
A: 这通常是 Nginx 缓存导致的。程序已尝试自动禁用缓存，但部分服务器配置可能较强硬。
* **解决方法**：尝试在 Nginx 配置文件中针对 PHP 添加 `fastcgi_buffering off;`。

**Q: 提示 `ob_implicit_flush() expects parameter 1 to be int`？**
A: 这是 PHP 版本兼容性问题。最新版代码已修复此问题，兼容 PHP 7.x 和 8.x，请确保使用的是最新版 `esa.php`。

**Q: 续费成功了，但没有扣款？**
A: 本工具仅生成**未支付订单**（Prepaid Order）。
* 如果您的账号有余额且开启了自动支付，可能会直接扣款。
* 否则，您需要登录阿里云控制台 -> **费用** -> **订单管理**，找到生成的订单手动完成支付。

---

## 🤝 贡献与反馈

如果您在使用过程中遇到问题，或有改进建议，欢迎提交 [Issue](https://github.com/tanlei888/ESA_Renew/issues) 或 Pull Request。

---

**Star 🌟 This Repo if it helps you!**
